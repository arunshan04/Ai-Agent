import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { Bar, Pie } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  ArcElement,
  Tooltip,
  Legend,
  Title
} from 'chart.js';

ChartJS.register(CategoryScale, LinearScale, BarElement, ArcElement, Tooltip, Legend, Title);

const CVESummaryCharts = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    axios.get('/api/cve-summary-charts/')
      .then(res => {
        setData(res.data);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load CVE summary charts.');
        setLoading(false);
      });
  }, []);

  if (loading) return <div>Loading charts...</div>;
  if (error) return <div style={{ color: 'red' }}>{error}</div>;
  if (!data) return null;

  // Severity Pie/Bar
  const severityLabels = Object.keys(data.severity);
  const severityCounts = Object.values(data.severity);
  // Monthly Bar
  const monthLabels = data.monthly.map(m => m.month).reverse();
  const monthCounts = data.monthly.map(m => m.count).reverse();
  // CVSS Histogram
  const cvssLabels = data.cvss.map(c => c.score);
  const cvssCounts = data.cvss.map(c => c.count);

  return (
    <>
      {/* CVEs by Severity */}
      <div className="dashboard-chart-box">
        <h3 style={{ textAlign: 'center' }}>CVEs by Severity</h3>
        <div style={{ width: 260, height: 250, margin: '0 auto' }}>
          <Pie
            data={{
              labels: severityLabels,
              datasets: [{
                data: severityCounts,
                backgroundColor: [
                  '#e57373', // null or unspecified
                  '#ffd54f', // CRITICAL
                  '#81c784', // HIGH
                  '#64b5f6', // LOW
                  '#ba68c8', // MEDIUM
                  '#eeeeee', // NONE
                ],
                borderColor: '#222',
                borderWidth: 2,
              }],
            }}
            options={{
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: {
                    color: '#222',
                    font: { weight: 'bold' },
                  },
                },
              },
            }}
            width={260}
            height={250}
          />
        </div>
      </div>
      {/* CVEs Published Per Month */}
      <div className="dashboard-chart-box">
        <h3 style={{ textAlign: 'center' }}>CVEs Published Per Month</h3>
        <Bar
          data={{
            labels: monthLabels,
            datasets: [{
              label: 'CVEs',
              data: monthCounts,
              backgroundColor: '#42a5f5',
            }],
          }}
          options={{
            maintainAspectRatio: false,
            responsive: false,
            plugins: {
              legend: { labels: { color: '#222' } },
            },
            scales: {
              x: { ticks: { color: '#222' } },
              y: { ticks: { color: '#222' } },
            },
          }}
          width={300}
          height={220}
        />
      </div>
      {/* CVEs by CVSS Score */}
      <div className="dashboard-chart-box">
        <h3 style={{ textAlign: 'center' }}>CVEs by CVSS Score</h3>
        <Bar
          data={{
            labels: cvssLabels,
            datasets: [{
              label: 'CVEs',
              data: cvssCounts,
              backgroundColor: '#66bb6a',
            }],
          }}
          options={{
            maintainAspectRatio: false,
            responsive: false,
            plugins: {
              legend: { labels: { color: '#222' } },
            },
            scales: {
              x: { ticks: { color: '#222' } },
              y: { ticks: { color: '#222' } },
            },
          }}
          width={300}
          height={220}
        />
      </div>
    </>
  );
};

export default CVESummaryCharts;
