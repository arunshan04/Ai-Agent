import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { Bar, Pie } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  ArcElement,
  Tooltip,
  Legend,
  Title
} from 'chart.js';

ChartJS.register(CategoryScale, LinearScale, BarElement, ArcElement, Tooltip, Legend, Title);

const CVESummaryCharts = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    axios.get('/api/cve-summary-charts/')
      .then(res => {
        setData(res.data);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load CVE summary charts.');
        setLoading(false);
      });
  }, []);

  if (loading) return <div>Loading charts...</div>;
  if (error) return <div style={{ color: 'red' }}>{error}</div>;
  if (!data) return null;

  // Severity Pie/Bar
  const severityLabels = Object.keys(data.severity);
  const severityCounts = Object.values(data.severity);
  // Monthly Bar
  const monthLabels = data.monthly.map(m => m.month).reverse();
  const monthCounts = data.monthly.map(m => m.count).reverse();
  // CVSS Histogram
  const cvssLabels = data.cvss.map(c => c.score);
  const cvssCounts = data.cvss.map(c => c.count);

  return (
    <div style={{ display: 'flex', gap: '2rem', justifyContent: 'center', alignItems: 'flex-start', marginBottom: 32 }}>
      {/* CVEs by Severity */}
      <div style={{ flex: 1, minWidth: 320 }}>
        <h3 style={{ textAlign: 'center' }}>CVEs by Severity</h3>
        <Pie
          data={{
            labels: severityLabels,
            datasets: [{
              data: severityCounts,
              backgroundColor: [
                '#e57373', // null or unspecified
                '#ffd54f', // CRITICAL
                '#81c784', // HIGH
                '#64b5f6', // LOW
                '#ba68c8', // MEDIUM
                '#eeeeee', // NONE
              ],
              borderColor: '#222',
              borderWidth: 2,
            }],
          }}
          options={{
            plugins: {
              legend: {
                labels: {
                  color: '#fff', // White text for dark backgrounds
                  font: { weight: 'bold' },
                },
              },
            },
          }}
        />
      </div>
      {/* CVEs Published Per Month */}
      <div style={{ flex: 1, minWidth: 320 }}>
        <h3 style={{ textAlign: 'center' }}>CVEs Published Per Month</h3>
        <Bar
          data={{
            labels: monthLabels,
            datasets: [{
              label: 'CVEs',
              data: monthCounts,
              backgroundColor: '#42a5f5',
            }],
          }}
          options={{
            responsive: true,
            plugins: {
              legend: { labels: { color: '#fff' } },
            },
            scales: {
              x: { ticks: { color: '#fff' } },
              y: { ticks: { color: '#fff' } },
            },
          }}
        />
      </div>
      {/* CVEs by CVSS Score */}
      <div style={{ flex: 1, minWidth: 320 }}>
        <h3 style={{ textAlign: 'center' }}>CVEs by CVSS Score</h3>
        <Bar
          data={{
            labels: cvssLabels,
            datasets: [{
              label: 'CVEs',
              data: cvssCounts,
              backgroundColor: '#66bb6a',
            }],
          }}
          options={{
            responsive: true,
            plugins: {
              legend: { labels: { color: '#fff' } },
            },
            scales: {
              x: { ticks: { color: '#fff' } },
              y: { ticks: { color: '#fff' } },
            },
          }}
        />
      </div>
    </div>
  );
};

export default CVESummaryCharts;
