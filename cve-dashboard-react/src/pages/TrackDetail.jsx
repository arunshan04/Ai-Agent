import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { getTrackDetail } from '../api/cveService';

const TrackDetail = () => {
    const { trackName } = useParams();
    const [trackData, setTrackData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        setLoading(true);
        getTrackDetail(trackName)
            .then(data => setTrackData(data))
            .catch(err => setError(`Failed to fetch details for track: ${trackName}.`))
            .finally(() => setLoading(false));
    }, [trackName]); // Rerun when trackName changes

    if (loading) return <div>Loading track details...</div>;
    if (error) return <div className="error-message">{error}</div>;
    if (!trackData) return <div>Track not found.</div>;

    return (
        <div>
            <h2>Track: {trackData.track.name}</h2>
            <p>{trackData.track.description}</p>

            {trackData.hosts.map(host => (
                <div key={host.id} className="host-card">
                    <h3>Host: {host.name} ({host.os_type})</h3>
                    {host.vulnerabilities.length > 0 ? (
                        host.vulnerabilities.map((vuln, index) => (
                            <div key={index} className="host-vuln-card">
                                <h4>{vuln.cve_id}: {vuln.cve_title}</h4>
                                <p>
                                    <b>Package:</b> {vuln.package_name} |
                                    <b> Score:</b> <span className="vuln-score">{vuln.score}</span> |
                                    <b> Impact:</b> <span className="vuln-impact">{vuln.impact}</span> |
                                    <b> Status:</b> {vuln.status}
                                </p>
                            </div>
                        ))
                    ) : (
                        <p>No vulnerabilities found for this host's packages.</p>
                    )}
                </div>
            ))}
        </div>
    );
};

export default TrackDetail;